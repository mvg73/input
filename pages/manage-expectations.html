<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Data Set Expectations</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <nav class="nav">
        <ul class="nav-links">
            <li><a href="wrangler-dashboard.html">Dashboard</a></li>
            <li><a href="manage-expectations.html">Expectations</a></li>
            <li><a href="manage-projects.html">Projects</a></li>
            <li><a href="manage-organizations.html">Organizations</a></li>
            <li><a href="manage-links.html">Links</a></li>
            <li><a href="data-ops.html">Data Ops</a></li>
            <li><a href="#" data-action="logout">Logout</a></li>
        </ul>
    </nav>

    <div class="page-header">
        <h1>Data Set Expectation Definitions</h1>
        <div class="user-info">
            <span data-user-name></span>
            <span data-user-email></span>
        </div>
    </div>

    <div class="container">
        <div id="pageMessage" class="message"></div>

        <div class="card">
            <h2 class="card-title" id="formTitle">Create New Expectation</h2>
            <form id="expectationForm">
                <input type="hidden" id="expectationId">

                <div class="form-group">
                    <label for="expectationName">Expectation Name</label>
                    <input type="text" id="expectationName" required placeholder="e.g., ZULU100">
                </div>

                <div class="form-group">
                    <label>Columns (Data Points)</label>
                    <div id="columnList" class="column-list"></div>
                    <button type="button" class="btn btn-secondary" onclick="addColumn()">+ Add Column</button>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Save Expectation</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2 class="card-title">Existing Expectations</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Columns</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expectationsList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Require wrangler access
        if (!Auth.requireWrangler()) {
            throw new Error('Access denied');
        }

        let columnCounter = 0;

        function addColumn(name = '', description = '', nullsOk = false, mustBeInt = false) {
            const id = columnCounter++;
            const div = document.createElement('div');
            div.className = 'column-item';
            div.id = `column-${id}`;
            div.style.flexWrap = 'wrap';
            div.innerHTML = `
                <input type="text" placeholder="Column name" value="${name}" data-field="name" required style="flex: 0 0 150px;">
                <input type="text" placeholder="Description (shown to user)" value="${description}" data-field="description" style="flex: 1; min-width: 200px;">
                <div class="checkbox-group">
                    <input type="checkbox" id="nullsOk-${id}" ${nullsOk ? 'checked' : ''} data-field="nullsOk">
                    <label for="nullsOk-${id}">Nulls OK</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="mustBeInt-${id}" ${mustBeInt ? 'checked' : ''} data-field="mustBeInt">
                    <label for="mustBeInt-${id}">Must be Int</label>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeColumn(${id})">Remove</button>
            `;
            document.getElementById('columnList').appendChild(div);
        }

        function removeColumn(id) {
            const el = document.getElementById(`column-${id}`);
            if (el) el.remove();
        }

        function getColumnsFromForm() {
            const columns = [];
            document.querySelectorAll('#columnList .column-item').forEach(item => {
                const name = item.querySelector('[data-field="name"]').value.trim();
                if (name) {
                    columns.push({
                        name: name,
                        description: item.querySelector('[data-field="description"]').value.trim(),
                        nullsOk: item.querySelector('[data-field="nullsOk"]').checked,
                        mustBeInt: item.querySelector('[data-field="mustBeInt"]').checked
                    });
                }
            });
            return columns;
        }

        function resetForm() {
            document.getElementById('expectationId').value = '';
            document.getElementById('expectationName').value = '';
            document.getElementById('columnList').innerHTML = '';
            document.getElementById('formTitle').textContent = 'Create New Expectation';
            columnCounter = 0;
            addColumn(); // Start with one empty column
        }

        function editExpectation(id) {
            const exp = Storage.getExpectation(id);
            if (!exp) return;

            document.getElementById('expectationId').value = exp.id;
            document.getElementById('expectationName').value = exp.name;
            document.getElementById('formTitle').textContent = 'Edit Expectation';

            // Clear and repopulate columns
            document.getElementById('columnList').innerHTML = '';
            columnCounter = 0;
            exp.columns.forEach(col => {
                addColumn(col.name, col.description || '', col.nullsOk, col.mustBeInt);
            });
        }

        function deleteExpectation(id) {
            if (confirm('Are you sure you want to delete this expectation? This will also remove all links to projects.')) {
                Storage.deleteExpectation(id);
                loadExpectations();
                App.showMessage('pageMessage', 'Expectation deleted successfully');
            }
        }

        function loadExpectations() {
            const expectations = Storage.getExpectations();
            const tbody = document.getElementById('expectationsList');

            if (expectations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--gray-500);">No expectations defined yet</td></tr>';
                return;
            }

            tbody.innerHTML = expectations.map(exp => `
                <tr>
                    <td><strong>${exp.name}</strong></td>
                    <td>
                        ${exp.columns.map(c => {
                            const tags = [];
                            if (!c.nullsOk) tags.push('required');
                            if (c.mustBeInt) tags.push('int');
                            const desc = c.description ? ` - "${c.description}"` : '';
                            return `<div style="margin-bottom: 4px;">${c.name}${desc} <small style="color: var(--gray-500);">(${tags.join(', ') || 'optional'})</small></div>`;
                        }).join('')}
                    </td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editExpectation('${exp.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteExpectation('${exp.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Form submission
        document.getElementById('expectationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const columns = getColumnsFromForm();
            if (columns.length === 0) {
                App.showMessage('pageMessage', 'Please add at least one column', true);
                return;
            }

            const expectation = {
                id: document.getElementById('expectationId').value || null,
                name: document.getElementById('expectationName').value.trim(),
                columns: columns
            };

            Storage.saveExpectation(expectation);
            resetForm();
            loadExpectations();
            App.showMessage('pageMessage', 'Expectation saved successfully');
        });

        // Initialize
        resetForm();
        loadExpectations();
    </script>
</body>
</html>
