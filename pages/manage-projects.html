<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Projects</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <nav class="nav">
        <ul class="nav-links">
            <li><a href="wrangler-dashboard.html">Dashboard</a></li>
            <li><a href="manage-expectations.html">Expectations</a></li>
            <li><a href="manage-projects.html">Projects</a></li>
            <li><a href="manage-organizations.html">Organizations</a></li>
            <li><a href="manage-links.html">Links</a></li>
            <li><a href="data-ops.html">Data Ops</a></li>
            <li><a href="#" data-action="logout">Logout</a></li>
        </ul>
    </nav>

    <div class="page-header">
        <h1>Manage Projects</h1>
        <div class="user-info">
            <span data-user-name></span>
            <span data-user-email></span>
        </div>
    </div>

    <div class="container">
        <div id="pageMessage" class="message"></div>

        <div class="card">
            <h2 class="card-title" id="formTitle">Create New Project</h2>
            <form id="projectForm">
                <input type="hidden" id="projectId">

                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" required placeholder="e.g., Preciousiuoisty">
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Save Project</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2 class="card-title">Existing Projects</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Linked Expectations</th>
                            <th>Linked Organizations</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projectsList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Require wrangler access
        if (!Auth.requireWrangler()) {
            throw new Error('Access denied');
        }

        function resetForm() {
            document.getElementById('projectId').value = '';
            document.getElementById('projectName').value = '';
            document.getElementById('formTitle').textContent = 'Create New Project';
        }

        function editProject(id) {
            const project = Storage.getProject(id);
            if (!project) return;

            document.getElementById('projectId').value = project.id;
            document.getElementById('projectName').value = project.name;
            document.getElementById('formTitle').textContent = 'Edit Project';
        }

        function deleteProject(id) {
            if (confirm('Are you sure you want to delete this project? This will also remove all links and collected data.')) {
                Storage.deleteProject(id);
                loadProjects();
                App.showMessage('pageMessage', 'Project deleted successfully');
            }
        }

        function loadProjects() {
            const projects = Storage.getProjects();
            const tbody = document.getElementById('projectsList');

            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--gray-500);">No projects defined yet</td></tr>';
                return;
            }

            tbody.innerHTML = projects.map(project => {
                const expectations = Storage.getExpectationsForProject(project.id);
                const orgLinks = Storage.getOrgProjectLinks().filter(l => l.projectId === project.id);
                const orgs = orgLinks.map(l => Storage.getOrganization(l.orgId)).filter(Boolean);

                return `
                    <tr>
                        <td><strong>${project.name}</strong></td>
                        <td>${expectations.length > 0 ? expectations.map(e => e.name).join(', ') : '<em style="color: var(--gray-500);">None</em>'}</td>
                        <td>${orgs.length > 0 ? orgs.map(o => o.name).join(', ') : '<em style="color: var(--gray-500);">None</em>'}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="editProject('${project.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProject('${project.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Form submission
        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const project = {
                id: document.getElementById('projectId').value || null,
                name: document.getElementById('projectName').value.trim()
            };

            Storage.saveProject(project);
            resetForm();
            loadProjects();
            App.showMessage('pageMessage', 'Project saved successfully');
        });

        // Initialize
        loadProjects();
    </script>
</body>
</html>
